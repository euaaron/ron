name: Publish Gallery

on:
  workflow_run:
    workflows:
      - Bump Version
    types:
      - completed

jobs:
  publish_gallery:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Pull latest changes
        shell: pwsh
        run: |
          git fetch --all
          git pull

      - name: Publish to PowerShell Gallery
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # Set API key from secret
          $apiKey = '${{ secrets.POWERSHELL_GALLERY_API_KEY }}'

          if ([string]::IsNullOrWhiteSpace($apiKey)) {
            Write-Error "POWERSHELL_GALLERY_API_KEY secret is not set"
            exit 1
          }

          Write-Host "Publishing ron module to PowerShell Gallery..." -ForegroundColor Cyan

          # Publish module
          Publish-Module -Path . -NuGetApiKey $apiKey -Verbose

          Write-Host "Module published successfully!" -ForegroundColor Green
